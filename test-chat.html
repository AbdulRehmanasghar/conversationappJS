<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio Conversation Chat Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold; 
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .messages { 
            border: 1px solid #ddd; 
            height: 350px; 
            overflow-y: auto; 
            padding: 10px; 
            margin: 10px 0; 
            background: #fafafa;
            border-radius: 5px;
        }
        .message { 
            margin: 5px 0; 
            padding: 8px; 
            border-left: 3px solid #007bff; 
            background: white;
            border-radius: 3px;
        }
        .message.own { 
            border-left-color: #28a745; 
            background: #f8f9fa; 
        }
        .message.user1 { 
            border-left-color: #dc3545; 
            background: #fff5f5; 
        }
        .message.user2 { 
            border-left-color: #6f42c1; 
            background: #f8f6ff; 
        }
        .message-author { 
            font-weight: bold; 
            color: #007bff; 
        }
        .message-time { 
            font-size: 12px; 
            color: #6c757d; 
        }
        input, button { 
            padding: 10px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        button { 
            background: #007bff; 
            color: white; 
            cursor: pointer; 
            border: none;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .user-buttons {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }
        .user-card {
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
            text-align: center;
        }
        .user-card.active {
            border-color: #007bff;
            background: #f8f9fa;
        }
        .user-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .user1-card { border-left: 4px solid #dc3545; }
        .user2-card { border-left: 4px solid #6f42c1; }
        .input-group { 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        .input-group input { 
            flex: 1; 
        }
        .typing { 
            font-style: italic; 
            color: #6c757d; 
            padding: 5px 10px;
        }
        .conversation-info {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #17a2b8;
        }
        .api-status {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí¨ Twilio Conversation Chat Test</h1>
        
        <div class="conversation-info">
            <h3>üìã Conversation Details</h3>
            <p><strong>Conversation ID:</strong> CHdcad65958cd348809b555eb1517acfb3</p>
            <p><strong>Name:</strong> P_2+test_1</p>
            <p><strong>Created:</strong> 2025-10-16</p>
        </div>
        
        <div class="user-buttons">
            <div class="user-card user1-card" id="user1-card">
                <h3>üë§ User 1</h3>
                <p><strong>Identity:</strong> P_2</p>
                <button onclick="connectAsUser('P_2')" id="user1-btn">Connect as User 1</button>
            </div>
            <div class="user-card user2-card" id="user2-card">
                <h3>üë§ User 2</h3>
                <p><strong>Identity:</strong> test_1</p>
                <button onclick="connectAsUser('test_1')" id="user2-btn">Connect as User 2</button>
            </div>
        </div>
        
        <div id="status" class="status disconnected">
            ‚ùå Not Connected
        </div>
        
        <div id="api-status" class="api-status" style="display: none;"></div>
        
        <div id="messages" class="messages"></div>
        
        <div id="typing-indicator" class="typing" style="display: none;"></div>
        
        <div class="input-group">
            <input type="text" id="message-input" placeholder="Type your message..." disabled>
            <button id="send-btn" onclick="sendMessage()" disabled>Send via Socket</button>
            <button onclick="sendViaAPI()" id="api-send-btn" disabled>Send via API</button>
        </div>
        
        <div class="input-group">
            <button onclick="loadMessages()">Load Messages</button>
            <button onclick="ping()">Ping Server</button>
            <button onclick="getOnlineUsers()">Get Online Users</button>
            <button onclick="clearMessages()">Clear Messages</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Twilio Conversation Configuration
        const CONVERSATION_SID = 'CHdcad65958cd348809b555eb1517acfb3';
        const API_BASE = '/api/conversations';
        
        // Current user and connection state
        let currentUser = null;
        let socket = null;
        let isConnected = false;
        let isInConversation = false;
        let typingTimer = null;

        // Connect as specific user
        async function connectAsUser(identity) {
            if (isConnected) {
                disconnect();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            currentUser = identity;
            updateStatus(`üîÑ Connecting as ${identity}...`, 'disconnected');
            
            try {
                // Generate token for user
                const tokenResponse = await fetch(`${API_BASE}/generate-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: identity })
                });
                
                const tokenData = await tokenResponse.json();
                showApiStatus(`‚úÖ Token generated for ${identity}`, 'success');
                
                // Connect to Socket.IO
                socket = io('/', {
                    transports: ['websocket', 'polling']
                });

                setupSocketEvents();
                
                // Update UI
                document.querySelectorAll('.user-card').forEach(card => {
                    card.classList.remove('active');
                });
                
                if (identity === 'P_2') {
                    document.getElementById('user1-card').classList.add('active');
                } else {
                    document.getElementById('user2-card').classList.add('active');
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                showApiStatus(`‚ùå Failed to connect: ${error.message}`, 'error');
                updateStatus('‚ùå Connection Failed', 'disconnected');
            }
        }

        function setupSocketEvents() {
            socket.on('connect', () => {
                console.log('üîå Connected to server');
                
                // Register user with server
                socket.emit('user_connect', {
                    userId: currentUser,
                    identity: currentUser
                });
            });

            socket.on('user_connected', (data) => {
                console.log('‚úÖ User registered:', data);
                isConnected = true;
                updateStatus(`‚úÖ Connected as ${currentUser}`, 'connected');
                
                // Auto-join the conversation
                joinConversation();
                enableInputs();
            });

            socket.on('joined_conversation', (data) => {
                console.log('üè† Joined conversation:', data);
                isInConversation = true;
                showApiStatus(`üè† Joined conversation: ${CONVERSATION_SID}`, 'success');
                loadMessages(); // Load existing messages
            });

            socket.on('new_message', (data) => {
                console.log('üí¨ New message:', data);
                displayMessage(data.message, false);
            });

            socket.on('user_joined', (data) => {
                console.log('üëã User joined:', data);
                addSystemMessage(`${data.identity} joined the conversation`);
            });

            socket.on('user_left', (data) => {
                console.log('üëã User left:', data);
                addSystemMessage(`${data.identity} left the conversation`);
            });

            socket.on('user_typing', (data) => {
                console.log('‚å®Ô∏è User typing:', data);
                showTyping(data.identity, data.isTyping);
            });

            socket.on('online_users', (data) => {
                console.log('üë• Online users:', data);
                showApiStatus(`üë• Online users: ${data.users.map(u => u.identity).join(', ')}`, 'info');
            });

            socket.on('pong', (data) => {
                console.log('üèì Pong:', data);
                showApiStatus('üèì Pong received', 'success');
            });

            socket.on('disconnect', () => {
                console.log('üîå Disconnected from server');
                isConnected = false;
                isInConversation = false;
                updateStatus('‚ùå Disconnected', 'disconnected');
                disableInputs();
            });

            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
                updateStatus('‚ùå Connection Error', 'disconnected');
                showApiStatus(`‚ùå Connection error: ${error.message}`, 'error');
            });
        }

        function joinConversation() {
            if (socket && isConnected) {
                socket.emit('join_conversation', {
                    conversationSid: CONVERSATION_SID,
                    identity: currentUser
                });
            }
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            isConnected = false;
            isInConversation = false;
            currentUser = null;
            updateStatus('‚ùå Disconnected', 'disconnected');
            disableInputs();
            
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        // Send message via Socket.IO
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !isConnected || !isInConversation) return;

            socket.emit('send_message', {
                conversationSid: CONVERSATION_SID,
                body: message,
                author: currentUser,
                media: []
            });

            messageInput.value = '';
            stopTyping();
        }

        // Send message via API
        async function sendViaAPI() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !currentUser) return;

            try {
                showApiStatus('üì§ Sending message via API...', 'info');
                
                const response = await fetch(`${API_BASE}/${CONVERSATION_SID}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        body: message,
                        author: currentUser,
                        media: []
                    })
                });

                const result = await response.json();
                
                if (result.status === 200) {
                    showApiStatus('‚úÖ Message sent via API', 'success');
                    // Don't display here - let Socket.IO broadcast handle it
                } else {
                    showApiStatus(`‚ùå API Error: ${result.message}`, 'error');
                }
                
                messageInput.value = '';
                
            } catch (error) {
                console.error('API send error:', error);
                showApiStatus(`‚ùå API Error: ${error.message}`, 'error');
            }
        }

        // Load existing messages from API
        async function loadMessages() {
            try {
                showApiStatus('üì• Loading messages...', 'info');
                
                const response = await fetch(`${API_BASE}/${CONVERSATION_SID}/messages`);
                const result = await response.json();
                
                if (result.status === 200) {
                    const messages = result.data;
                    
                    // Clear current messages
                    document.getElementById('messages').innerHTML = '';
                    
                    // Display all messages
                    messages.forEach(message => {
                        displayMessage(message, false);
                    });
                    
                    showApiStatus(`‚úÖ Loaded ${messages.length} messages`, 'success');
                } else {
                    showApiStatus(`‚ùå Failed to load messages: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Load messages error:', error);
                showApiStatus(`‚ùå Load error: ${error.message}`, 'error');
            }
        }

        function displayMessage(message, isOwn = false) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            
            let messageClass = 'message';
            if (isOwn) {
                messageClass += ' own';
            } else if (message.author === 'P_2') {
                messageClass += ' user1';
            } else if (message.author === 'test_1') {
                messageClass += ' user2';
            }
            
            messageElement.className = messageClass;
            
            const time = message.dateCreated ? new Date(message.dateCreated).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            messageElement.innerHTML = `
                <div class="message-author">${message.author}</div>
                <div>${message.body}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.style.borderLeftColor = '#6c757d';
            messageElement.style.fontStyle = 'italic';
            messageElement.innerHTML = `
                <div style="color: #6c757d;">${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTyping(identity, isTyping) {
            const typingIndicator = document.getElementById('typing-indicator');
            
            if (isTyping && identity !== currentUser) {
                typingIndicator.textContent = `${identity} is typing...`;
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
        }

        function startTyping() {
            if (socket && isConnected && isInConversation) {
                socket.emit('typing_start', {
                    conversationSid: CONVERSATION_SID,
                    identity: currentUser
                });
            }
        }

        function stopTyping() {
            if (socket && isConnected && isInConversation) {
                socket.emit('typing_stop', {
                    conversationSid: CONVERSATION_SID,
                    identity: currentUser
                });
            }
        }

        function ping() {
            if (socket && isConnected) {
                socket.emit('ping');
            }
        }

        function getOnlineUsers() {
            if (socket && isConnected && isInConversation) {
                socket.emit('get_online_users', {
                    conversationSid: CONVERSATION_SID
                });
            }
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function showApiStatus(message, type) {
            const apiStatusDiv = document.getElementById('api-status');
            apiStatusDiv.textContent = message;
            apiStatusDiv.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                apiStatusDiv.style.display = 'none';
            }, 3000);
        }

        function enableInputs() {
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('api-send-btn').disabled = false;
        }

        function disableInputs() {
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('api-send-btn').disabled = true;
        }

        // Handle Enter key in message input
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            } else {
                // Handle typing indicators
                clearTimeout(typingTimer);
                startTyping();
                
                typingTimer = setTimeout(() => {
                    stopTyping();
                }, 2000);
            }
        });

        // Initialize
        updateStatus('üöÄ Ready to connect', 'disconnected');
        console.log('üí¨ Twilio Conversation Chat Test initialized');
        console.log('üîó Conversation SID:', CONVERSATION_SID);
    </script>
</body>
</html>